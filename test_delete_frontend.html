<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Case Deletion</title>
    <script src="config.js"></script>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ccc; }
        .log { background: #f0f0f0; padding: 10px; margin: 10px 0; font-family: monospace; }
        button { padding: 10px 15px; margin: 5px; }
        .success { color: green; }
        .error { color: red; }
        .info { color: blue; }
    </style>
</head>
<body>
    <h1>🧪 Case Deletion Test</h1>
    
    <div class="test-section">
        <h2>1. Configuration Test</h2>
        <button onclick="testConfig()">Test Config</button>
        <div id="configLog" class="log"></div>
    </div>
    
    <div class="test-section">
        <h2>2. Authentication Test</h2>
        <button onclick="testAuth()">Check Token</button>
        <div id="authLog" class="log"></div>
    </div>
    
    <div class="test-section">
        <h2>3. Get Cases Test</h2>
        <button onclick="getCases()">Get Cases</button>
        <div id="casesLog" class="log"></div>
    </div>
    
    <div class="test-section">
        <h2>4. Delete Case Test</h2>
        <input type="text" id="cnrInput" placeholder="Enter CNR Number" style="width: 300px;">
        <button onclick="testDelete()">Delete Case</button>
        <div id="deleteLog" class="log"></div>
    </div>

    <script>
        let apiBaseUrl = '';
        
        function log(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            const timestamp = new Date().toLocaleTimeString();
            const className = type === 'error' ? 'error' : (type === 'success' ? 'success' : 'info');
            element.innerHTML += `<div class="${className}">[${timestamp}] ${message}</div>`;
            console.log(`[${timestamp}] ${message}`);
        }
        
        async function testConfig() {
            const logId = 'configLog';
            document.getElementById(logId).innerHTML = '';
            
            try {
                log(logId, '🔧 Testing config initialization...', 'info');
                
                if (typeof config === 'undefined') {
                    log(logId, '❌ Config object not found', 'error');
                    return;
                }
                
                await config.init();
                apiBaseUrl = config.getApiUrl('');
                
                log(logId, `✅ Config initialized`, 'success');
                log(logId, `🌐 API Base URL: ${apiBaseUrl}`, 'info');
                
                // Test server info endpoint
                const response = await fetch(config.getApiUrl('/server-info'));
                if (response.ok) {
                    const data = await response.json();
                    log(logId, `✅ Server info: ${JSON.stringify(data)}`, 'success');
                } else {
                    log(logId, `⚠️ Server info failed: ${response.status}`, 'error');
                }
                
            } catch (error) {
                log(logId, `❌ Config test failed: ${error.message}`, 'error');
            }
        }
        
        async function testAuth() {
            const logId = 'authLog';
            document.getElementById(logId).innerHTML = '';
            
            try {
                const token = localStorage.getItem('userToken');
                
                if (!token) {
                    log(logId, '❌ No token found in localStorage', 'error');
                    log(logId, '💡 You need to login first', 'info');
                    return;
                }
                
                log(logId, `✅ Token found: ${token.substring(0, 20)}...`, 'success');
                
                // Test token validity
                if (!apiBaseUrl) await testConfig();
                
                const response = await fetch(`${apiBaseUrl}/auth/profile`, {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    log(logId, `✅ Token valid - User: ${data.user.username} (${data.user.email})`, 'success');
                } else {
                    log(logId, `❌ Token invalid: ${response.status}`, 'error');
                }
                
            } catch (error) {
                log(logId, `❌ Auth test failed: ${error.message}`, 'error');
            }
        }
        
        async function getCases() {
            const logId = 'casesLog';
            document.getElementById(logId).innerHTML = '';
            
            try {
                if (!apiBaseUrl) await testConfig();
                
                const token = localStorage.getItem('userToken');
                if (!token) {
                    log(logId, '❌ No token found', 'error');
                    return;
                }
                
                log(logId, '📋 Getting cases...', 'info');
                
                const response = await fetch(`${apiBaseUrl}/cases`, {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                log(logId, `📡 Response status: ${response.status}`, 'info');
                
                if (response.ok) {
                    const data = await response.json();
                    log(logId, `✅ Cases retrieved: ${data.cases ? data.cases.length : 0} cases`, 'success');
                    
                    if (data.cases && data.cases.length > 0) {
                        data.cases.slice(0, 3).forEach(case => {
                            log(logId, `📂 ${case.cnr_number}: ${case.case_title || 'No title'}`, 'info');
                        });
                    }
                } else {
                    const errorText = await response.text();
                    log(logId, `❌ Failed to get cases: ${errorText}`, 'error');
                }
                
            } catch (error) {
                log(logId, `❌ Get cases failed: ${error.message}`, 'error');
            }
        }
        
        async function testDelete() {
            const logId = 'deleteLog';
            document.getElementById(logId).innerHTML = '';
            
            try {
                const cnr = document.getElementById('cnrInput').value.trim();
                if (!cnr) {
                    log(logId, '❌ Please enter a CNR number', 'error');
                    return;
                }
                
                if (!apiBaseUrl) await testConfig();
                
                const token = localStorage.getItem('userToken');
                if (!token) {
                    log(logId, '❌ No token found', 'error');
                    return;
                }
                
                log(logId, `🗑️ Attempting to delete case: ${cnr}`, 'info');
                
                // First check if case exists
                log(logId, '🔍 Checking if case exists...', 'info');
                const checkResponse = await fetch(`${apiBaseUrl}/cases/${cnr}`, {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                log(logId, `📡 Check response status: ${checkResponse.status}`, 'info');
                
                if (checkResponse.status === 404) {
                    log(logId, '❌ Case not found', 'error');
                    return;
                } else if (!checkResponse.ok) {
                    const errorText = await checkResponse.text();
                    log(logId, `❌ Error checking case: ${errorText}`, 'error');
                    return;
                }
                
                const caseData = await checkResponse.json();
                log(logId, `✅ Case found: ${caseData.case?.case_title || 'No title'}`, 'success');
                
                // Now attempt deletion
                log(logId, '🗑️ Sending DELETE request...', 'info');
                
                const deleteResponse = await fetch(`${apiBaseUrl}/cases/${cnr}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                log(logId, `📡 Delete response status: ${deleteResponse.status}`, 'info');
                log(logId, `📡 Delete response headers: ${JSON.stringify([...deleteResponse.headers.entries()])}`, 'info');
                
                if (deleteResponse.ok) {
                    const result = await deleteResponse.json();
                    log(logId, `✅ Delete successful: ${JSON.stringify(result)}`, 'success');
                } else {
                    const errorText = await deleteResponse.text();
                    log(logId, `❌ Delete failed: ${deleteResponse.status} - ${errorText}`, 'error');
                }
                
            } catch (error) {
                log(logId, `❌ Delete test failed: ${error.message}`, 'error');
                log(logId, `🔍 Error details: ${error.stack}`, 'error');
            }
        }
        
        // Auto-initialize
        document.addEventListener('DOMContentLoaded', async () => {
            console.log('🚀 Test page loaded');
            await testConfig();
        });
    </script>
</body>
</html>
