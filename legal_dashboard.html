<!DOCTYPE html>
<html lang="en">
<head>
    <script src="config.js"></script>
    <script src="common.js"></script>
    <script src="cache-manager.js"></script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Legal Management Dashboard</title>
    <link rel="stylesheet" href="shared-dashboard-styles.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f9fbfc;
            color: #232323;
        }

        .dashboard-container {
            display: flex;
            min-height: 100vh;
        }

        /* Sidebar */
        .sidebar {
            width: 250px;
            background: #232B3E;
            color: white;
            padding: 20px 0;
            position: fixed;
            height: 100vh;
            overflow-y: auto;
            box-shadow: 4px 0 20px rgba(44,62,80,0.15);
        }

        .sidebar-header {
            padding: 0 20px 20px;
            border-bottom: 1px solid #e5e7eb;
        }

        .sidebar-header h2 {
            font-size: 22px;
            margin-bottom: 8px;
            color: #15803d;
            font-weight: 700;
        }

        .sidebar-header p {
            font-size: 13px;
            opacity: 0.8;
            color: #6b7280;
        }

        .nav-menu {
            padding: 20px 0;
        }

        .nav-item {
            padding: 12px 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 10px;
            text-decoration: none;
            color: white;
        }

        .nav-item:hover {
            background: linear-gradient(90deg, rgba(25,118,210,0.2), rgba(33,150,243,0.1));
            transform: translateX(5px);
            border-left: 3px solid #1976D2;
            box-shadow: 0 4px 15px rgba(25, 118, 210, 0.2);
        }

        .nav-item.active {
            background: linear-gradient(90deg, rgba(25,118,210,0.3), rgba(33,150,243,0.2));
            border-left: 4px solid #1976D2;
            color: #2196F3;
            box-shadow: 0 4px 15px rgba(25, 118, 210, 0.3);
        }

        .nav-item i {
            width: 20px;
        }

        /* Main Content */
        .main-content {
            margin-left: 250px;
            flex: 1;
            padding: 20px;
        }

        /* Header styles moved to shared-dashboard-styles.css */

        /* User info and avatar styles moved to shared-dashboard-styles.css */

        /* User avatar hover moved to shared-dashboard-styles.css */

        /* Dashboard Grid */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .card {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 4px 20px rgba(44,62,80,0.08);
            transition: all 0.3s ease;
            border: 1px solid rgba(44,62,80,0.05);
        }

        .card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 30px rgba(44,62,80,0.12);
            border-left: 4px solid #15803d;
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .card-title {
            font-size: 20px;
            font-weight: 600;
            color: #232323;
        }

        .card-icon {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 18px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }

        .stat-item {
            text-align: center;
            padding: 18px;
            background: white;
            border-radius: 10px;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(44,62,80,0.08);
            border: 1px solid rgba(44,62,80,0.05);
        }

        .stat-item:hover {
            background: white;
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(44,62,80,0.12);
            border-left: 4px solid #15803d;
        }

        .stat-number {
            font-size: 28px;
            font-weight: bold;
            color: #15803d;
            margin-bottom: 8px;
        }

        .stat-label {
            font-size: 13px;
            color: #666;
            margin-top: 5px;
            font-weight: 500;
        }

        /* Status Colors */
        .status-success {
            background: #98FB98;
            color: #43A047;
            padding: 4px 12px;
            border-radius: 15px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .status-warning {
            background: #FFF3CD;
            color: #FFC107;
            padding: 4px 12px;
            border-radius: 15px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .status-error {
            background: #F8D7DA;
            color: #E53935;
            padding: 4px 12px;
            border-radius: 15px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .accent-green {
            color: #15803d;
            font-weight: 600;
        }

        /* Enhanced Button Styles */
        .btn-primary {
            background: linear-gradient(45deg, #1976D2, #2196F3);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(25, 118, 210, 0.3);
        }

        .btn-primary:hover {
            background: linear-gradient(45deg, #1565C0, #1976D2);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(25, 118, 210, 0.4);
        }

        .btn-success {
            background: linear-gradient(45deg, #43A047, #66BB6A);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(67, 160, 71, 0.3);
        }

        .btn-success:hover {
            background: linear-gradient(45deg, #388E3C, #43A047);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(67, 160, 71, 0.4);
        }

        .btn-warning {
            background: linear-gradient(45deg, #FFC107, #FFD54F);
            color: #333;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(255, 193, 7, 0.3);
        }

        .btn-warning:hover {
            background: linear-gradient(45deg, #FF8F00, #FFC107);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(255, 193, 7, 0.4);
        }

        .btn-green {
            background: #15803d;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
            transition: all 0.2s ease;
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
        }

        .btn-green:hover {
            background: #166534;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px 0 rgba(21, 128, 61, 0.15);
        }

        .logout-btn {
            background: #dc2626;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.2s ease;
            margin-left: 20px;
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .logout-btn:hover {
            background: #b91c1c;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px 0 rgba(220, 38, 38, 0.15);
        }

        .logout-btn:active {
            transform: translateY(0);
        }

        .logout-btn:focus {
            outline: none;
            box-shadow: 0 0 0 3px rgba(220, 38, 38, 0.3);
        }

        /* Case List */
        .case-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .case-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px;
            border-bottom: 1px solid rgba(44,62,80,0.08);
            transition: all 0.3s ease;
            border-radius: 8px;
            margin-bottom: 4px;
        }

        .case-item:hover {
            background: rgba(25, 118, 210, 0.02);
            transform: translateX(4px);
            border-left: 3px solid #1976D2;
            box-shadow: 0 2px 8px rgba(44,62,80,0.08);
        }

        .case-info h4 {
            font-size: 15px;
            margin-bottom: 6px;
            color: #232323;
            font-weight: 600;
        }

        .case-info p {
            font-size: 13px;
            color: #666;
        }

        .case-status {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: bold;
        }

        .status-pending {
            background: #fff3cd;
            color: #856404;
        }

        .status-active {
            background: #d1ecf1;
            color: #0c5460;
        }

        .status-completed {
            background: #d4edda;
            color: #155724;
        }

        /* Hearing List */
        .hearing-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .hearing-item {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px;
            border-bottom: 1px solid #ecf0f1;
            transition: background 0.3s;
        }

        .hearing-item:hover {
            background: #fef5e7;
            transform: translateX(5px);
            box-shadow: 0 2px 8px rgba(243, 156, 18, 0.2);
        }

        .hearing-date {
            text-align: center;
            min-width: 50px;
        }

        .date-day {
            font-size: 18px;
            font-weight: bold;
            color: #3498db;
        }

        .date-month {
            font-size: 10px;
            color: #7f8c8d;
            text-transform: uppercase;
        }

        .hearing-info {
            flex: 1;
        }

        .hearing-info h4 {
            font-size: 14px;
            margin-bottom: 5px;
            color: #2c3e50;
        }

        .hearing-info p {
            font-size: 12px;
            color: #7f8c8d;
            margin-bottom: 5px;
        }

        .hearing-type {
            font-size: 10px;
            color: #3498db;
            background: #e8f4fd;
            padding: 2px 6px;
            border-radius: 3px;
        }

        /* Recent Activity */
        .activity-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 0;
            border-bottom: 1px solid #ecf0f1;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .activity-item:hover {
            background: #fef5e7;
            padding-left: 10px;
            border-radius: 6px;
        }

        .activity-icon {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: #3498db;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 12px;
        }

        .activity-content h4 {
            font-size: 13px;
            margin-bottom: 2px;
        }

        .activity-content p {
            font-size: 11px;
            color: #7f8c8d;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
                transition: transform 0.3s;
            }

            .main-content {
                margin-left: 0;
            }

            .dashboard-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="dashboard-container">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="sidebar-header">
                <h2>LegalPro</h2>
                <p>Management System</p>
            </div>
            <nav class="nav-menu">
                <div class="nav-item active">
                    <i>📊</i>
                    <span>Dashboard</span>
                </div>
                <a href="cases.html" class="nav-item">
                    <i>📁</i>
                    <span>Cases</span>
                </a>
                <a href="clients.html" class="nav-item">
                    <i>👥</i>
                    <span>Clients</span>
                </a>
                <a href="calendar.html" class="nav-item">
                    <i>📅</i>
                    <span>Calendar</span>
                </a>
                <!-- <a href="settings.html" class="nav-item">
                    <i>⚙️</i>
                    <span>Settings</span>
                </a> -->
            </nav>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Header -->
            <div class="header">
                <h1>Dashboard</h1>
                <div class="user-info">
                    <button onclick="clearAllCache()" class="btn btn-secondary" title="Clear all cached data">
                        <i class="fas fa-sync-alt"></i> Clear Cache
                    </button>
                    <span id="welcomeMessage">Welcome, Loading...</span>
                    <div class="user-avatar" id="userAvatar">--</div>
                    <button onclick="logout()" class="logout-btn" title="Logout">Logout</button>
                </div>
            </div>

            <!-- Dashboard Grid -->
            <div class="dashboard-grid">
                <!-- Overview Stats -->
                <div class="card" style="background: linear-gradient(135deg, #e8f4fd 0%, #f8f9fa 100%);">
                    <div class="card-header">
                        <h3 class="card-title">Overview</h3>
                    </div>
                    <div class="stats-grid">
                        <div class="stat-item">
                            <div class="stat-number" id="activeCasesCount">0</div>
                            <div class="stat-label">Active Cases</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-number" id="totalCasesCount">0</div>
                            <div class="stat-label">Total Cases</div>
                        </div>
                        <div class="stat-item" onclick="showTodayHearings()" style="cursor: pointer;">
                            <div class="stat-number" id="todayHearingsCount">0</div>
                            <div class="stat-label">Today's Hearings</div>
                        </div>
                    </div>
                </div>

                <!-- Upcoming Hearings -->
                <div class="card" style="background: linear-gradient(135deg, #e8f4fd 0%, #f8f9fa 100%);">
                    <div class="card-header">
                        <h3 class="card-title">Upcoming Hearings</h3>
                    </div>
                    <div class="hearing-list" id="upcomingHearings">
                        <div class="hearing-item">
                            <div class="hearing-date">
                                <div class="date-day">--</div>
                                <div class="date-month">---</div>
                            </div>
                            <div class="hearing-info">
                                <h4>Loading cases...</h4>
                                <p>Fetching data from database</p>
                                <span class="hearing-type">Loading</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Real Cases -->
                <div class="card" style="background: linear-gradient(135deg, #e8f4fd 0%, #f8f9fa 100%);">
                    <div class="card-header">
                        <h3 class="card-title">Recent Cases</h3>
                    </div>
                    <div class="activity-list" id="recentCases">
                        <div class="activity-item">
                            <div class="activity-content">
                                <h4>Loading cases...</h4>
                                <p>Fetching data from database</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Case History - Removed as requested -->
                <!-- <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Case History</h3>
                        <div class="card-icon" style="background: #f39c12;">📅</div>
                    </div>
                    <div class="activity-list">
                        <div class="activity-item" onclick="showAllCaseHistory()" style="cursor: pointer;">
                            <div class="activity-icon">📋</div>
                            <div class="activity-content">
                                <h4>View All Case History</h4>
                                <p id="totalHistoryCount">Loading history...</p>
                            </div>
                        </div>
                        <div class="activity-item" onclick="showTodayHearings()" style="cursor: pointer;">
                            <div class="activity-icon">🕐</div>
                            <div class="activity-content">
                                <h4>Today's Hearings</h4>
                                <p id="todayHearingsText">Loading today's schedule...</p>
                            </div>
                        </div>
                    </div>
                </div> -->
            </div>
        </div>
    </div>
    
    <script>
        // Notification system
        // Authentication and User Profile Functions
        function checkAuth() {
            console.log('🔐 checkAuth called');
            const token = localStorage.getItem('userToken');
            console.log('Token found:', !!token);
            
            if (!token) {
                console.log('❌ No token found, redirecting to login');
                // Redirect to login if no token
                window.location.href = 'login.html';
                return;
            }
            
            // Check what user data we have
            const userData = localStorage.getItem('userData');
            const username = localStorage.getItem('username');
            console.log('User data in localStorage:', !!userData);
            console.log('Username in localStorage:', username);
            
            // Load user profile
            loadUserProfile();
        }

        async function loadUserProfile() {
            try {
                // Try to get user data from localStorage first (set during login)
                const userData = localStorage.getItem('userData');
                if (userData) {
                    const user = JSON.parse(userData);
                    updateUserDisplay(user);
                    return;
                }

                // Fallback: try to get from profile API
                // Ensure config is initialized first
                if (!config.initialized) {
                    await config.init();
                }
                
                const token = localStorage.getItem('userToken');
                if (!token) {
                    console.error('No authentication token found');
                    return;
                }

                const response = await fetch(config.getApiUrl('/auth/profile'), {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    const profileData = await response.json();
                    if (profileData.success && profileData.user) {
                        const user = profileData.user;
                        // Store user data for future use
                        localStorage.setItem('userData', JSON.stringify(user));
                        updateUserDisplay(user);
                        console.log('User profile loaded from API:', user);
                    }
                } else {
                    console.error('Failed to load user profile:', response.status);
                    // Try to get basic info from token
                    await loadBasicUserInfo();
                }
            } catch (error) {
                console.error('Error loading user profile:', error);
                // Try to get basic info from token
                await loadBasicUserInfo();
            }
        }

        async function loadBasicUserInfo() {
            try {
                const token = localStorage.getItem('userToken');
                if (!token) return;

                // Try to get username from localStorage
                const username = localStorage.getItem('username');
                if (username) {
                    const user = {
                        username: username,
                        full_name: username.charAt(0).toUpperCase() + username.slice(1)
                    };
                    updateUserDisplay(user);
                    return;
                }

                // If no username in localStorage, try to decode token
                // This is a simple fallback - in a real app you'd use proper JWT decoding
                if (token && token.length > 20) {
                    // For now, show a generic welcome
                    const user = {
                        username: 'User',
                        full_name: 'Legal User'
                    };
                    updateUserDisplay(user);
                }
            } catch (error) {
                console.error('Error loading basic user info:', error);
            }
        }

        function updateUserDisplay(user) {
            // Update welcome message
            const welcomeMessage = document.getElementById('welcomeMessage');
            if (welcomeMessage) {
                welcomeMessage.textContent = `Welcome, ${user.full_name || user.username}`;
            }
            
            // Update user avatar
            const userAvatar = document.getElementById('userAvatar');
            if (userAvatar) {
                const initials = getUserInitials(user.full_name || user.username);
                userAvatar.textContent = initials;
            }
        }

        function getUserInitials(name) {
            if (!name) return '--';
            const parts = name.split(' ');
            if (parts.length >= 2) {
                return (parts[0][0] + parts[1][0]).toUpperCase();
            }
            return name[0].toUpperCase();
        }

        async function logout() {
            try {
                const token = localStorage.getItem('userToken');
                if (token) {
        // Wait for config to initialize
                    if (!config.initialized) {
        await config.init();
                    }
        
                    // Call logout API
                    await fetch(config.getApiUrl('/auth/logout'), {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    });
                }
                
                // Clear local storage and redirect
                localStorage.removeItem('userToken');
                localStorage.removeItem('userRole');
                window.location.href = 'login.html';
            } catch (error) {
                console.error('Error during logout:', error);
                // Still redirect even if API call fails
                localStorage.removeItem('userToken');
                localStorage.removeItem('userRole');
                window.location.href = 'login.html';
            }
        }

        // LegalAPI class definition
        class LegalAPI {
            constructor(baseUrl = null) {
                this.baseUrl = baseUrl;
                this.initialized = false;
            }

            async init() {
                if (!this.initialized) {
                    if (!config.initialized) {
                        await config.init();
                    }
                    this.baseUrl = config.getApiUrl('');
                    this.initialized = true;
                    console.log('🔧 LegalAPI initialized with baseUrl:', this.baseUrl);
                }
            }

            // Get all cases
            async getCases(userId = null, limit = 50, offset = 0) {
                try {
                    // Ensure API is initialized
                    if (!this.initialized) {
                        await this.init();
                    }
                    
                    let url = `${this.baseUrl}/cases?limit=${limit}&offset=${offset}`;
                    if (userId) url += `&user_id=${userId}`;
                    
                    // Get the auth token from localStorage
                    const token = localStorage.getItem('userToken');
                    console.log('🔍 DEBUG: Token for API call:', token ? 'EXISTS' : 'MISSING');
                    console.log('🔍 DEBUG: API URL:', url);
                    
                    if (!token) {
                        console.error('No auth token found');
                        return { success: false, error: 'No authentication token' };
                    }
                    
                    const response = await fetch(url, {
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        }
                    });
                    
                    console.log('🔍 DEBUG: API Response status:', response.status);
                    console.log('🔍 DEBUG: API Response ok:', response.ok);
                    
                    if (response.status === 401) {
                        console.error('❌ 401 Unauthorized - Token may be expired');
                        console.log('🔄 Redirecting to login page...');
                        localStorage.removeItem('userToken');
                        localStorage.removeItem('userRole');
                        window.location.href = 'login.html';
                        return { success: false, error: 'Unauthorized - redirecting to login' };
                    }
                    
                    return await response.json();
                } catch (error) {
                    console.error('Error getting cases:', error);
                    return { success: false, error: error.message };
                }
            }

            // Get case history
            async getCaseHistory(cnrNumber) {
                try {
                    // Ensure API is initialized
                    if (!this.initialized) {
                        await this.init();
                    }
                    
                    // Get the auth token from localStorage
                    const token = localStorage.getItem('userToken');
                    if (!token) {
                        console.error('No auth token found');
                        return { success: false, error: 'No authentication token' };
                    }
                    
                    const response = await fetch(`${this.baseUrl}/case_history/${cnrNumber}`, {
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        }
                    });
                    return await response.json();
                } catch (error) {
                    console.error('Error getting case history:', error);
                    return { success: false, error: error.message };
                }
            }
        }

        // Decompress data if it's compressed
        function decompressData(compressedData) {
            try {
                // Decode base64
                const binaryString = atob(compressedData);
                
                // Convert to Uint8Array
                const bytes = new Uint8Array(binaryString.length);
                for (let i = 0; i < binaryString.length; i++) {
                    bytes[i] = binaryString.charCodeAt(i);
                }
                
                // Decompress using pako (if available) or fallback
                if (typeof pako !== 'undefined') {
                    const decompressed = pako.inflate(bytes, { to: 'string' });
                    return JSON.parse(decompressed);
                } else {
                    // Fallback: try to parse as JSON (in case compression failed)
                    console.warn('⚠️ Pako not available, trying to parse as JSON');
                    return JSON.parse(compressedData);
                }
            } catch (error) {
                console.error('❌ Decompression failed:', error);
                // Fallback: try to parse as JSON
                try {
                    return JSON.parse(compressedData);
                } catch (parseError) {
                    console.error('❌ JSON parsing also failed:', parseError);
                    return null;
                }
            }
        }

        // Initialize API
        const legalAPI = new LegalAPI();

        // Update dashboard display with data
        async function updateDashboardDisplay(dashboardData, showNotification = false) {
            // Validate dashboardData structure
            if (!dashboardData) {
                console.error('❌ updateDashboardDisplay: dashboardData is undefined');
                return;
            }
            
            const cases = dashboardData.cases || [];
            const clients = dashboardData.clients || [];
            const calendarEvents = dashboardData.calendar_events || [];
            
            console.log(`📊 Dashboard Display: ${cases.length} cases, ${clients.length} clients, ${calendarEvents.length} events`);
            
            // Update stats
            document.getElementById('totalCasesCount').textContent = cases.length;
            document.getElementById('activeCasesCount').textContent = cases.filter(c => c.status === 'Active').length;
            
            // Calculate today's hearings count
            if (cases.length > 0 && dashboardData.case_histories) {
                const today = new Date().toDateString();
                let todayHearingsCount = 0;
                
                // case_histories is an object with CNR keys, not an array
                Object.values(dashboardData.case_histories).forEach(caseHistory => {
                    if (caseHistory.history && Array.isArray(caseHistory.history)) {
                        caseHistory.history.forEach(entry => {
                            if (entry.hearing_date) {
                                const entryDate = new Date(entry.hearing_date).toDateString();
                                if (entryDate === today) {
                                    todayHearingsCount++;
                                }
                            }
                        });
                    }
                });
                
                document.getElementById('todayHearingsCount').textContent = todayHearingsCount;
            }
            
            // Store cases globally
            window.allCases = cases;
            window.currentCases = cases;
            
            // Display cases using the correct functions
            displayRecentCases(cases.slice(0, 5));
            
            // Display upcoming hearings
            await displayUpcomingHearings(cases.slice(0, 4));
            
            // Show success notification only if requested (for API loads, not cache hits)
            if (showNotification) {
                if (typeof showNotification === 'function') {
                    showNotification(`✅ Loaded ${cases.length} cases!`, 'success');
                } else {
                    console.log('✅ Loaded', cases.length, 'cases!');
                }
            }
        }

        // Listen for cache updates from other pages (add/edit/delete operations)
        function listenForCacheUpdates() {
            let lastCacheUpdate = localStorage.getItem('cacheUpdated');
            console.log('📊 Dashboard: Starting cache listener, initial timestamp:', lastCacheUpdate);
            
            setInterval(() => {
                const currentCacheUpdate = localStorage.getItem('cacheUpdated');
                if (currentCacheUpdate && currentCacheUpdate !== lastCacheUpdate) {
                    console.log('📊 Dashboard: Cache update detected, refreshing data...');
                    console.log('📊 Previous timestamp:', lastCacheUpdate);
                    console.log('📊 New timestamp:', currentCacheUpdate);
                    
                    // Use CacheManager for consistent cache handling
                    if (window.cacheManager) {
                        window.cacheManager.clearCache();
                        console.log('📊 Dashboard: Cleared cache using CacheManager');
                    } else {
                        // Fallback to manual cache clearing
                        localStorage.removeItem('userDashboardData');
                        localStorage.removeItem('cacheVersion');
                        localStorage.removeItem('cacheUpdated');
                        if (window.userDashboardData) {
                            delete window.userDashboardData;
                        }
                        console.log('📊 Dashboard: Cleared cache manually (CacheManager not available)');
                    }
                    
                    lastCacheUpdate = currentCacheUpdate;
                    
                    // Force refresh dashboard data
                    loadDashboardData(true); // true = force refresh
                }
            }, 5000); // Check every 5 seconds - REDUCED FREQUENCY FOR PERFORMANCE
        }

        // Load dashboard data (SMART CACHE MODE!)
        let isLoading = false; // Prevent duplicate API calls
        // Clear all cache function
        function clearAllCache() {
            console.log('🧹 Dashboard: Clearing ALL cache...');
            // Use CacheManager for consistent cache handling
            if (window.cacheManager) {
                window.cacheManager.clearCache();
                console.log('🧹 Dashboard: Cleared cache using CacheManager');
            } else {
                // Fallback to manual cache clearing
                localStorage.removeItem('userDashboardData');
                localStorage.removeItem('cacheVersion');
                localStorage.removeItem('cacheUpdated');
                if (window.userDashboardData) {
                    delete window.userDashboardData;
                }
                console.log('🧹 Dashboard: Cleared cache manually (CacheManager not available)');
            }
            alert('Cache cleared! Reloading dashboard...');
            loadDashboardData(true); // Force refresh
        }

        async function loadDashboardData(forceRefresh = false) {
            try {
                // Prevent duplicate loads
                if (isLoading && !forceRefresh) {
                    console.log('🔄 Dashboard already loading, skipping duplicate request');
                    return;
                }
                
                // Check if we already have valid cached data (unless forcing refresh)
                if (!forceRefresh && window.userDashboardData && 
                    window.userDashboardData.cases && 
                    Array.isArray(window.userDashboardData.cases) && 
                    window.userDashboardData.cases.length > 0) {
                    console.log('💾 CACHE HIT: Using existing dashboard data (no API call needed)');
                    updateDashboardDisplay(window.userDashboardData);
                    return;
                }
                
                // Also check localStorage cache with versioning
                // Use CacheManager for consistent cache handling
                if (!forceRefresh && window.cacheManager && window.cacheManager.isCacheValid()) {
                    const cachedData = window.cacheManager.getCachedData();
                    if (cachedData && cachedData.cases && cachedData.cases.length > 0) {
                        console.log('💾 CACHEMANAGER HIT: Using cached dashboard data (no API call needed)');
                        window.userDashboardData = cachedData;
                        updateDashboardDisplay(cachedData);
                        return;
                    }
                }
                
                console.log('🔄 CacheManager: Cache invalid or not available, fetching from API...');
                
                console.log('🚀 Loading ALL user data from API (SUPER FAST MODE)...');
                isLoading = true;
                
                // Ensure config is initialized first
                if (!config.initialized) {
                    console.log('🔄 Initializing config...');
                    await config.init();
                }
                
                // Get the auth token from localStorage
                const token = localStorage.getItem('userToken');
                if (!token) {
                    console.error('No auth token found');
                    showNotification('❌ No authentication token found', 'error');
                    isLoading = false;
                    return;
                }
                
                // Call the new super-fast endpoint
                const response = await fetch(config.getApiUrl('/user/dashboard-data'), {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                const result = await response.json();
                
                // Add debug logging for API response
                console.log('🔍 DEBUG: Dashboard API response:', result);
                console.log('🔍 DEBUG: Response success:', result.success);
                console.log('🔍 DEBUG: Dashboard data:', result.dashboard_data);
                console.log('🔍 DEBUG: Compressed:', result.compressed);
                
                // Handle compressed data
                let dashboardData = result.dashboard_data;
                if (result.compressed && typeof dashboardData === 'string') {
                    console.log('🗜️ DEBUG: Data is compressed, decompressing...');
                    dashboardData = decompressData(dashboardData);
                    if (!dashboardData) {
                        console.error('❌ Failed to decompress data');
                        showNotification('❌ Failed to load dashboard data', 'error');
                        isLoading = false;
                        return;
                    }
                    console.log('✅ DEBUG: Data decompressed successfully');
                }
                
                if (dashboardData) {
                    console.log('🔍 DEBUG: Cases count:', dashboardData.cases ? dashboardData.cases.length : 'No cases array');
                    console.log('🔍 DEBUG: First case:', dashboardData.cases ? dashboardData.cases[0] : 'No cases');
                }
                
                if (result.success && dashboardData) {
                    // Validate the dashboard data structure
                    const cases = dashboardData.cases || [];
                    const clients = dashboardData.clients || [];
                    const calendarEvents = dashboardData.calendar_events || [];
                    
                    console.log(`✅ API LOADED: ${cases.length} cases, ${clients.length} clients, ${calendarEvents.length} events`);
                    
                    // Store all data globally for other pages
                    window.userDashboardData = dashboardData;
                    
                    // ALSO store in localStorage for cross-page access
                    localStorage.setItem('userDashboardData', JSON.stringify(dashboardData));
                    localStorage.setItem('cacheVersion', Date.now().toString());
                    
                    console.log('💾 Data cached globally and in localStorage');
                    
                    // Update the display
                    updateDashboardDisplay(dashboardData, true); // true = show success notification
                    
                } else {
                    console.error('❌ Failed to load user data:', result.error || 'Unknown error');
                    console.log('❌ API response:', result);
                    console.error('❌ No data available - dashboard will show empty');
                    
                    // Create empty dashboard data structure
                    const emptyDashboardData = {
                        cases: [],
                        clients: [],
                        calendar_events: [],
                        case_histories: {}
                    };
                    
                    // Update display with empty data
                    updateDashboardDisplay(emptyDashboardData, false);
                }
                
                isLoading = false; // Reset loading flag
                
            } catch (error) {
                console.error('❌ Error loading user data (fast mode):', error);
                console.log('Falling back to slow method...');
                
                isLoading = false; // Reset loading flag
                
                // await loadDashboardDataSlow(); // Fallback to old method - COMMENTED OUT FOR PERFORMANCE
                console.error('❌ No data available - dashboard will show empty');
            }
        }

        // Fallback slow method (kept for compatibility) - COMMENTED OUT FOR PERFORMANCE
        /*
        async function loadDashboardDataSlow() {
            try {
                console.log('🔄 Loading dashboard data (SLOW FALLBACK)...');
                
                // Load cases
                const casesResult = await legalAPI.getCases();
                if (casesResult.success && casesResult.cases) {
                    const cases = casesResult.cases;
                    
                    // Update stats
                    document.getElementById('totalCasesCount').textContent = cases.length;
                    document.getElementById('activeCasesCount').textContent = cases.filter(c => c.status === 'Active').length;
                    
                    // Case history loading removed since Case History section was removed
                    // Load case history count for first case
                    if (cases.length > 0) {
                        const historyResult = await legalAPI.getCaseHistory(cases[0].cnr_number);
                        if (historyResult.success && historyResult.history) {
                            // Count today's hearings for the stats
                            const today = new Date().toDateString();
                            const todayHearings = historyResult.history.filter(entry => {
                                const entryDate = new Date(entry.hearing_date).toDateString();
                                return entryDate === today;
                            });
                            
                            document.getElementById('todayHearingsCount').textContent = todayHearings.length;
                        }
                    }
                    
                    // Display recent cases
                    displayRecentCases(cases.slice(0, 5));
                    
                    // Display upcoming hearings (now uses real hearing dates)
                    await displayUpcomingHearings(cases.slice(0, 4));
                }
            } catch (error) {
                console.error('Error loading dashboard data:', error);
            }
        }
        */

        // Display recent cases
        function displayRecentCases(cases) {
            const recentCasesContainer = document.getElementById('recentCases');
            if (!cases || cases.length === 0) {
                recentCasesContainer.innerHTML = `
                    <div class="activity-item">
                        <div class="activity-icon">📁</div>
                        <div class="activity-content">
                            <h4>No cases found</h4>
                            <p>No cases available in the database</p>
                        </div>
                    </div>
                `;
                return;
            }

            recentCasesContainer.innerHTML = '';
            cases.forEach(caseData => {
                const caseItem = document.createElement('div');
                caseItem.className = 'activity-item';
                caseItem.style.cursor = 'pointer';
                caseItem.onclick = () => {
                    sessionStorage.setItem('viewCaseCNR', caseData.cnr_number);
                    window.location.href = 'case_details.html';
                };
                
                caseItem.innerHTML = `
                    <div class="activity-icon">📁</div>
                    <div class="activity-content">
                        <h4>${caseData.case_title || 'Untitled Case'}</h4>
                        <p>CNR: ${caseData.cnr_number} • ${caseData.case_type || 'Unknown Type'}</p>
                    </div>
                `;
                recentCasesContainer.appendChild(caseItem);
            });
        }

        // Display upcoming hearings
        async function displayUpcomingHearings(cases) {
            const hearingsContainer = document.getElementById('upcomingHearings');
            if (!cases || cases.length === 0) {
                hearingsContainer.innerHTML = `
                    <div class="hearing-item">
                        <div class="hearing-date">
                            <div class="date-day">--</div>
                            <div class="date-month">---</div>
                        </div>
                        <div class="hearing-info">
                            <h4>No cases found</h4>
                            <p>No cases available</p>
                            <span class="hearing-type">N/A</span>
                        </div>
                    </div>
                `;
                return;
            }

            hearingsContainer.innerHTML = '';
            const upcomingHearings = [];
            const today = new Date();
            today.setHours(0, 0, 0, 0); // Reset time to start of day
            
            // Collect all future hearings from all cases using cached dashboard data
            if (!window.userDashboardData?.case_histories) {
                console.log('⚠️ No cached case histories available');
                hearingsContainer.innerHTML = '<div class="hearing-item"><div class="hearing-info"><h4>No upcoming hearings</h4><p>No case history data available</p></div></div>';
                return;
            }
            
            // Process cases efficiently without excessive logging
            for (const caseData of cases) {
                const caseHistory = window.userDashboardData.case_histories[caseData.cnr_number];
                
                if (caseHistory?.history && Array.isArray(caseHistory.history)) {
                    caseHistory.history.forEach(entry => {
                            if (entry.hearing_date) {
                                const hearingDate = new Date(entry.hearing_date);
                            hearingDate.setHours(0, 0, 0, 0);
                                
                                // Only include future hearings
                                if (hearingDate >= today) {
                                    upcomingHearings.push({
                                        date: hearingDate,
                                    originalDate: new Date(entry.hearing_date),
                                        caseData: caseData,
                                        purpose: entry.purpose,
                                    orderDetails: entry.order_details,
                                    judge: entry.judge,
                                    cnr: caseData.cnr_number,
                                    caseTitle: caseData.case_title || 'Unknown Case'
                                    });
                                }
                            }
                        });
                }
            }
            
            // Sort by date (earliest first) and take first 4
            upcomingHearings.sort((a, b) => a.date - b.date);
            const nextHearings = upcomingHearings.slice(0, 4);
            
            if (nextHearings.length === 0) {
                hearingsContainer.innerHTML = `
                    <div class="hearing-item">
                        <div class="hearing-date">
                            <div class="date-day">--</div>
                            <div class="date-month">---</div>
                        </div>
                        <div class="hearing-info">
                            <h4>No upcoming hearings</h4>
                            <p>All hearing dates are in the past</p>
                            <span class="hearing-type">Check case history for details</span>
                        </div>
                    </div>
                `;
                return;
            }
            
            console.log('✅ DEBUG: Displaying upcoming hearings:', nextHearings.map(h => `${h.cnr} on ${h.date.toDateString()}`));
            
            // Display upcoming hearings with real dates
            nextHearings.forEach(hearing => {
                const hearingItem = document.createElement('div');
                hearingItem.className = 'hearing-item';
                hearingItem.style.cursor = 'pointer';
                hearingItem.onclick = () => {
                    sessionStorage.setItem('viewCaseCNR', hearing.caseData.cnr_number);
                    window.location.href = 'case_details.html';
                };
                
                hearingItem.innerHTML = `
                    <div class="hearing-date">
                        <div class="date-day">${hearing.date.getDate()}</div>
                        <div class="date-month">${hearing.date.toLocaleDateString('en-US', { month: 'short' }).toUpperCase()}</div>
                    </div>
                    <div class="hearing-info">
                        <h4>${hearing.caseData.case_title || 'Untitled Case'}</h4>
                        <p>${hearing.purpose || 'Hearing'} • ${hearing.originalDate.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true })}</p>
                        <span class="hearing-type">${hearing.caseData.case_type || 'Unknown'}</span>
                    </div>
                `;
                hearingsContainer.appendChild(hearingItem);
            });
        }

        // Today's Hearings functionality - restored
        async function showTodayHearings() {
            console.log('🔍 DEBUG: showTodayHearings function called!');
            try {
                // Get cases first
                console.log('🔍 DEBUG: Getting cases from API...');
                const casesResult = await legalAPI.getCases();
                console.log('🔍 DEBUG: Cases result:', casesResult);
                
                if (!casesResult.success || !casesResult.cases || casesResult.cases.length === 0) {
                    console.log('⚠️ DEBUG: No cases found, showing no hearings modal');
                    showNoTodayHearingsModal();
                    return;
                }
                
                console.log('✅ DEBUG: Found', casesResult.cases.length, 'cases');

                // Get case history for all cases and filter for today
                const today = new Date().toDateString();
                let todayHearings = [];
                
                for (const caseData of casesResult.cases) {
                    try {
                        const historyResult = await legalAPI.getCaseHistory(caseData.cnr_number);
                        if (historyResult.success && historyResult.history) {
                            const caseTodayHearings = historyResult.history.filter(entry => {
                                if (entry.hearing_date) {
                                    const entryDate = new Date(entry.hearing_date).toDateString();
                                    return entryDate === today;
                                }
                                return false;
                            });
                            
                            caseTodayHearings.forEach(hearing => {
                                todayHearings.push({
                                    caseData: caseData,
                                    hearing: hearing
                                });
                            });
                        }
                    } catch (error) {
                        console.error(`Error getting history for case ${caseData.cnr_number}:`, error);
                    }
                }

                console.log('🔍 DEBUG: Total today hearings found:', todayHearings.length);

                if (todayHearings.length === 0) {
                    console.log('⚠️ DEBUG: No hearings today, showing no hearings modal');
                    showNoTodayHearingsModal();
                    return;
                }

                console.log('✅ DEBUG: Showing today hearings modal with', todayHearings.length, 'hearings');
                showTodayHearingsModal(todayHearings);
            } catch (error) {
                console.error('Error loading today\'s hearings:', error);
                showNoTodayHearingsModal();
            }
        }

        // Show modal for today's hearings specifically
        function showTodayHearingsModal(todayHearings) {
            const today = new Date();
            
            let hearingsHtml = `
                <div style="max-height: 400px; overflow-y: auto;">
                    <h3 style="margin-bottom: 20px; color: #2c3e50;">Today's Hearings - ${today.toLocaleDateString()}</h3>
                    <div style="display: grid; gap: 15px;">
            `;

            todayHearings.forEach(item => {
                const { caseData, hearing } = item;
                const date = new Date(hearing.hearing_date);
                const timeStr = date.toLocaleTimeString('en-US', { 
                    hour: '2-digit', 
                    minute: '2-digit',
                    hour12: true 
                });

                hearingsHtml += `
                    <div style="background: #e8f5e8; padding: 15px; border-radius: 8px; border-left: 4px solid #27ae60; box-shadow: 0 2px 5px rgba(0,0,0,0.1);">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <div style="font-weight: 600; color: #2c3e50; margin-bottom: 5px;">
                                    ${timeStr} - ${hearing.purpose || 'Hearing'}
                                </div>
                                <div style="font-size: 14px; color: #27ae60; margin-bottom: 3px;">
                                    <strong>Case:</strong> ${caseData.case_title || 'Untitled Case'}
                                </div>
                                <div style="font-size: 14px; color: #7f8c8d;">
                                    CNR: ${caseData.cnr_number} • ${caseData.case_type || 'Case Type'}
                                </div>
                                <div style="font-size: 14px; color: #7f8c8d;">
                                    ${caseData.court_name || 'Court'}
                                </div>
                                ${hearing.order_details ? `<div style="font-size: 12px; color: #95a5a6; margin-top: 5px;">Details: ${hearing.order_details}</div>` : ''}
                            </div>
                        </div>
                    </div>
                `;
            });

            hearingsHtml += `
                    </div>
                </div>
            `;

            createModal('Today\'s Hearings', hearingsHtml, '#27ae60');
        }

        // Show modal when no hearings today
        function showNoTodayHearingsModal() {
            const today = new Date();
            const noHearingsHtml = `
                <div style="text-align: center; padding: 40px 20px;">
                    <div style="font-size: 48px; margin-bottom: 20px;">🏛️</div>
                    <h3 style="color: #2c3e50; margin-bottom: 15px;">No Hearings Today</h3>
                    <p style="color: #7f8c8d; margin-bottom: 20px;">
                        No hearings are scheduled for ${today.toLocaleDateString()}.
                    </p>
                    <p style="color: #95a5a6; font-size: 14px;">
                        Check the calendar or upcoming hearings for future dates.
                    </p>
                </div>
            `;

            createModal('Today\'s Hearings', noHearingsHtml, '#3498db');
        }

        // Case History related functions - Commented out since Case History section was removed
        /*
        // Show all case history function
        async function showAllCaseHistory() {
            try {
                // Get cases first
                const casesResult = await legalAPI.getCases();
                if (!casesResult.success || !casesResult.cases || casesResult.cases.length === 0) {
                    showNoHearingsModal();
                    return;
                }

                // Get case history for the first case
                const firstCase = casesResult.cases[0];
                const historyResult = await legalAPI.getCaseHistory(firstCase.cnr_number);
                
                if (!historyResult.success || !historyResult.history || historyResult.history.length === 0) {
                    showNoHearingsModal();
                    return;
                }

                showHearingsModal(firstCase, historyResult.history);
            } catch (error) {
                console.error('Error loading case history:', error);
                showNoHearingsModal();
            }
        }

        // Show modal with real case history
        function showHearingsModal(caseData, historyEntries) {
            const today = new Date();
            
            let hearingsHtml = `
                <div style="max-height: 400px; overflow-y: auto;">
                    <h3 style="margin-bottom: 20px; color: #2c3e50;">Case History - ${caseData.cnr_number}</h3>
                    <div style="margin-bottom: 15px; padding: 10px; background: #f8f9fa; border-radius: 5px;">
                        <strong>Case:</strong> ${caseData.case_title || 'Untitled Case'}<br>
                        <strong>Type:</strong> ${caseData.case_type || 'Unknown'}<br>
                        <strong>Court:</strong> ${caseData.court_name || 'Unknown Court'}
                    </div>
                    <div style="display: grid; gap: 10px;">
            `;

            // Show recent 10 history entries
            const recentHistory = historyEntries.slice(0, 10);
            recentHistory.forEach(entry => {
                const date = new Date(entry.hearing_date);
                const formattedDate = date.toLocaleDateString('en-US', { 
                    weekday: 'short',
                    year: 'numeric', 
                    month: 'short', 
                    day: 'numeric' 
                });

                hearingsHtml += `
                    <div style="background: white; padding: 15px; border-radius: 8px; border-left: 4px solid #3498db; box-shadow: 0 2px 5px rgba(0,0,0,0.1);">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <div style="font-weight: 600; color: #2c3e50; margin-bottom: 5px;">${formattedDate} - ${entry.purpose || 'Hearing'}</div>
                                <div style="font-size: 14px; color: #7f8c8d;">${caseData.court_name || 'Court'} • ${caseData.case_type || 'Case Type'}</div>
                                ${entry.order_details ? `<div style="font-size: 12px; color: #95a5a6; margin-top: 5px;">Details: ${entry.order_details}</div>` : ''}
                            </div>
                        </div>
                    </div>
                `;
            });

            if (historyEntries.length > 10) {
                hearingsHtml += `
                    <div style="text-align: center; padding: 10px; color: #7f8c8d; font-style: italic;">
                        ... and ${historyEntries.length - 10} more entries
                    </div>
                `;
            }

            hearingsHtml += `
                    </div>
                </div>
            `;

            createModal('Case History', hearingsHtml);
        }

        // Show modal when no hearings available
        function showNoHearingsModal() {
            const noHearingsHtml = `
                <div style="text-align: center; padding: 40px;">
                    <div style="font-size: 48px; margin-bottom: 20px;">📅</div>
                    <h3 style="color: #2c3e50; margin-bottom: 10px;">No Case History Available</h3>
                    <p style="color: #7f8c8d;">No hearing records found in the database.</p>
                    <button onclick="window.location.href='cases.html'" style="margin-top: 20px; padding: 10px 20px; background: #3498db; color: white; border: none; border-radius: 5px; cursor: pointer;">
                        View All Cases
                    </button>
                </div>
            `;
            createModal('Case History', noHearingsHtml);
        }
        */

        // Create modal helper function
        function createModal(title, content, color = '#3498db') {
            console.log('🔍 DEBUG: createModal called with title:', title);
            console.log('🔍 DEBUG: Modal content length:', content.length);
            
            // Create modal
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.5);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 1000;
            `;

            const modalContent = document.createElement('div');
            modalContent.style.cssText = `
                background: white;
                padding: 30px;
                border-radius: 8px;
                max-width: 700px;
                width: 90%;
                max-height: 80vh;
                overflow-y: auto;
                position: relative;
            `;

            modalContent.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2 style="color: #2c3e50; margin: 0;">${title}</h2>
                    <button onclick="this.closest('.modal-overlay').remove()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #7f8c8d;">×</button>
                </div>
                ${content}
            `;

            modal.appendChild(modalContent);
            modal.className = 'modal-overlay';
            document.body.appendChild(modal);
            
            console.log('✅ DEBUG: Modal added to DOM with class:', modal.className);
            console.log('✅ DEBUG: Modal element:', modal);
            console.log('✅ DEBUG: Total modals in DOM:', document.querySelectorAll('.modal-overlay').length);

            // Close modal when clicking outside
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    modal.remove();
                }
            });
        }

        // Test function - you can call this from browser console: testModal()
        function testModal() {
            console.log('🧪 Testing modal creation...');
            createModal('Test Modal', '<p>This is a test modal. If you can see this, the modal system is working!</p><button onclick="this.closest(\'.modal-overlay\').remove()" style="padding: 10px 20px; background: #3498db; color: white; border: none; border-radius: 5px; cursor: pointer; margin-top: 10px;">Close</button>');
        }

        // Add interactivity
        document.querySelectorAll('.nav-item').forEach(item => {
            item.addEventListener('click', function() {
                document.querySelectorAll('.nav-item').forEach(nav => nav.classList.remove('active'));
                this.classList.add('active');
            });
        });

        // Load data when page loads
        document.addEventListener('DOMContentLoaded', async function() {
            try {
                // Initialize config first
                console.log('🔄 Initializing config on page load...');
                await config.init();
                console.log('✅ Config initialized successfully');
                
                // Then check auth and load data
            checkAuth();
                await loadDashboardData();
                
                // Start listening for cache updates from other pages
                listenForCacheUpdates();
            } catch (error) {
                console.error('❌ Error during page initialization:', error);
            }
        });
    </script>
</body>
</html> 
